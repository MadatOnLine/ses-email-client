<!DOCTYPE html>
<html lang="en" class="has-navbar-fixed-top">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>favicon.ico">
    <title>SES Template Display</title>
    <!-- <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet"> -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.738.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css" integrity="sha256-aPeK/N8IHpHsvPBCf49iVKMdusfobKo2oxF8lRruWJg=" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js" integrity="sha256-ur/YlHMU96MxHEsy3fHGszZHas7NzH4RQlD4tDVvFhw=" crossorigin="anonymous"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MQ28N2K');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MQ28N2K"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="app">
      <nav class="container navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <a class="navbar-item is-small title" href="/"><img width="112" height="28" src="../images/zeer0.png" alt="Zeer0"></a>
          <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample" click="awsModalIsVisible = true">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>
        <div class="navbar-menu">
          <div class="navbar-start is-hidden">
          </div>
          <div class="navbar-end">
            <div class="navbar-item">
              <button class="button is-medium is-primary is-outlined" @click="awsModalIsVisible = true">Add AWS Credentials</button>
            </div>
          </div>
        </div>
      </nav>
      <div class="container has-text-centered">
        <div v-if="templatesLength === 0">SES templates will appear here...</div>
        <div v-else>
          <span v-for="templateData in this.templates.TemplatesMetadata" @click="getTemplate(templateData.Name)"><a :class="templateData.Name === currentTemplateName && templateIsLoading? 'is-loading' :''" class="button">{{templateData.Name}}</a></span>
        </div>
        <div class="columns is-centered mt-2" v-if="templatesLength > 0">
          <div class="column"></div>
          <div class="column">
            <button class="button is-medium is-primary is-outlined is-block" :class="templatesAreLoading ? 'is-loading':''" :disabled="buttonShouldBeDisabled" @click="getTemplates(); awsModalIsVisible = false">Load More templates</button>
          </div>
          <div class="column"></div>
        </div>
      </div>
      <div class="modal" :class="currentTemplateModalIsVisible ? 'is-active':''">
        <div class="modal-background" @click="currentTemplateModalIsVisible = false"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title is-large">{{currentTemplateName}}</p>
            <button class="modal-close is-large" aria-label="close" @click="currentTemplateModalIsVisible = false"></button>
          </header>
          <section class="modal-card-body">
            <div class="text-center" v-if="!iframeSrc"><span>Template will appear here...</span></div>
            <div v-else>
              <iframe frameborder="0" style="overflow:hidden;overflow-x:hidden;overflow-y:hidden;height:100vh;width:100%;" height="100vh" width="100vw" v-bind:src="iframeSrc"></iframe>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-medium is-primary is-outlined" @click="currentTemplateModalIsVisible = false">Okay!</button>
          </footer>
        </div>
      </div>
      <div class="modal" :class="privacyPolicyModalIsVisible ? 'is-active':''">
        <div class="modal-background" @click="privacyPolicyModalIsVisible = false"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title is-large">Privacy Policy</p>
            <button class="modal-close is-large" aria-label="close" @click="privacyPolicyModalIsVisible = false"></button>
          </header>
          <section class="modal-card-body">
            <div class="content is-medium">
              <p>- We don't ever receive or store your AWS Key, secret, and region information. It is saved in your browser and sent directly to Amazon AWS to download information relevant to YOU!</p>
              <p>- We use Google Analytics to see how our site is being used, not for advertising.</p>
              <p>- That's it!</p>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-medium is-primary is-outlined" @click="privacyPolicyModalIsVisible = false">Okay!</button>
          </footer>
        </div>
      </div>
      <div class="modal" :class="awsModalIsVisible ? 'is-active':''">
        <div class="modal-background" @click="awsModalIsVisible = false"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title is-large">Your AWS Credentials</p>
            <button class="modal-close is-large" aria-label="close" @click="awsModalIsVisible = false"></button>
          </header>
          <section class="modal-card-body">
            <div class="content is-medium">
              <div class="container">
                <div class="field is-block">
                  <div class="control">
                    <input class="input" type="text" placeholder="AWS Secret Access " v-model="secretAccessKey">
                  </div>
                </div>
                <div class="field is-block">
                  <div class="control">
                    <div class="select is-primary" v-if="this.sesRegions">
                      <select v-model="region">
                        <option disabled value="">Select AWS region</option>
                        <option v-for="sesRegion in this.sesRegions.regions" v-if="sesRegion.visible" :selected="sesRegion.id === region" :value="sesRegion.id">{{sesRegion.name}} - {{sesRegion.location}}</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="field is-block">
                  <div class="control">
                    <div class="select is-primary" v-if="this.sesRegions">
                      <select v-model="region">
                        <option disabled value="">Select AWS region</option>
                        <option v-for="sesRegion in this.sesRegions.regions" v-if="sesRegion.visible" :selected="sesRegion.id === region" :value="sesRegion.id">{{sesRegion.name}} - {{sesRegion.location}}</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="is-block">
                  <label class="checkbox">
                    <input type="checkbox" v-model="dataMustBeSavedLocally"> Remember key, secret, and region
                  </label>
                </div>
              </div>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-medium is-primary is-outlined is-block" :class="templatesAreLoading ? 'is-loading':''" :disabled="buttonShouldBeDisabled" @click="getTemplates(); awsModalIsVisible = false">Get my SES templates</button>
          </footer>
        </div>
      </div>
      <footer class="footer">
        <div class="content has-text-centered">
          <div v-if="templatesLength === 0">
            <p>
              <strong>Welcome!</strong> Enter your AWS Key, Secret, and select your AWS SES Region to see your SES Templates.
            </p>
          </div>
          <p>Your AWS Key, Secret, and region are never transmitted to our server. Here is the rest of our very short <a @click="privacyPolicyModalIsVisible = true">privacy policy</a>.</p>
          <p class="is-hidden-tablet">
            This page looks much better on a desktop. You can use it here but it isn't ideal.
          </p>
        </div>
      </footer>
    </div>
  </body>
  <script type="text/javascript">
    var app = new Vue({
      el: '#app',
      data: {
        message: 'Hello Vue!',
        accessKeyId: undefined,
        secretAccessKey : undefined,
        region: "",
        ses: undefined,
        templates: undefined,
        nextToken: undefined,
        nextTokenBecameNull: false,
        iframeSrc: undefined,
        sesRegions: undefined,
        templateIsLoading: undefined,
        templatesAreLoading: undefined,
        currentTemplateName: "Template name will appear here...",
        dataMustBeSavedLocally: false,
        privacyPolicyModalIsVisible: false,
        awsModalIsVisible: false,
        currentTemplateModalIsVisible: false,
      },
      watch: {
        accessKeyId: function(n, o){
          this.getSESObject(n != o);
          this.updateLocalData();
        },
        secretAccessKey: function(n, o){
          this.getSESObject(n != o);
          this.updateLocalData();
        },
        region: function(n, o){
          this.getSESObject(n != o);
          this.updateLocalData();
        },
        dataMustBeSavedLocally: function(n, o){
          this.updateLocalData();
        },
        nextToken: function(n, o){
          if(!n && o){
            this.nextTokenBecameNull = true;
          }
        },
      },
      mounted(){
        this.sesRegions = {"regions":[{"id":"us-east-1","name":"US East","location":"N. Virginia","optIn":false,"visible":true},{"id":"us-east-2","name":"US East","location":"Ohio","optIn":false,"visible":true},{"id":"us-west-1","name":"US West","location":"N. California","optIn":false},{"id":"us-west-2","name":"US West","location":"Oregon","optIn":false,"visible":true},{"id":"af-south-1","name":"Africa","location":"Cape Town","optIn":true},{"id":"ap-east-1","name":"Asia Pacific","location":"Hong Kong","optIn":true},{"id":"ap-south-1","name":"Asia Pacific","location":"Mumbai","optIn":false,"visible":true},{"id":"ap-northeast-2","name":"Asia Pacific","location":"Seoul","optIn":false,"visible":true},{"id":"ap-southeast-1","name":"Asia Pacific","location":"Singapore","optIn":false,"visible":true},{"id":"ap-southeast-2","name":"Asia Pacific","location":"Sydney","optIn":false},{"id":"ap-northeast-1","name":"Asia Pacific","location":"Tokyo","optIn":false,"visible":true},{"id":"ca-central-1","name":"Canada","location":"Central","optIn":false},{"id":"eu-central-1","name":"Europe","location":"Frankfurt","optIn":false,"visible":true},{"id":"eu-west-1","name":"Europe","location":"Ireland","optIn":false,"visible":true},{"id":"eu-west-2","name":"Europe","location":"London","optIn":false,"visible":true},{"id":"eu-south-1","name":"Europe","location":"Milan","optIn":true},{"id":"eu-west-3","name":"Europe","location":"Paris","optIn":false},{"id":"eu-north-1","name":"Europe","location":"Stockholm","optIn":false},{"id":"me-south-1","name":"Middle East","location":"Bahrain","optIn":true},{"id":"sa-east-1","name":"South America","location":"São Paulo","optIn":false,"visible":true}]};
        this.readLocalData();
      },
      computed: {
        templatesLength: function(){
          return this.templates && this.templates.TemplatesMetadata ? this.templates.TemplatesMetadata.length : 0;
        },
        buttonShouldBeDisabled: function(){
          return this.nextTokenBecameNull || !(this.accessKeyId && this.secretAccessKey && this.region !== "");
        }
      },
      methods: {
        showPrivacyPolicyModal2: function(){
          this.privacyPolicyModalIsVisible = true;
        },
        updateLocalData: function(){
          localStorage.accessKeyId = this.dataMustBeSavedLocally ? (this.accessKeyId ? this.accessKeyId : '') : '';
          localStorage.secretAccessKey = this.dataMustBeSavedLocally ? (this.secretAccessKey ? this.secretAccessKey : '') : '';
          localStorage.region = this.dataMustBeSavedLocally ? (this.region ? this.region : '') : '';
        },
        readLocalData: function(){
          this.accessKeyId = localStorage.accessKeyId ? localStorage.accessKeyId : undefined;
          this.secretAccessKey = localStorage.secretAccessKey ? localStorage.secretAccessKey : undefined;
          this.region = localStorage.region ? localStorage.region : "";
          if(this.accessKeyId || this.secretAccessKey || this.region) this.dataMustBeSavedLocally = true;
        },
        getSESObject: function(refresh) {
          if(this.accessKeyId && this.secretAccessKey && this.region !== ""){
            if(!this.ses || refresh){
              this.ses = new AWS.SES({
                apiVersion: '2010-12-01',
                accessKeyId: this.accessKeyId,
                secretAccessKey: this.secretAccessKey,
                region: this.region
              });
              this.templates = {};
            }
          } else {
            this.ses = undefined;
            this.templates = {};
          }
        },
        setTemplateMetadataReactive: function(arr){
          Vue.set(app.templates, 'TemplatesMetadata', arr);
        },
        getTemplate: _.throttle(
          async function(tName){
            if(this.ses){
              var params = { TemplateName: tName };
              let vm = this;
              vm.templateIsLoading = true;
              vm.currentTemplateName = tName;
              await this.ses.getTemplate(params).promise()
                .then(template => {
                  const blob = new Blob([template.Template.HtmlPart], { type: 'text/html' });
                  vm.iframeSrc = URL.createObjectURL(blob);
                  vm.currentTemplateModalIsVisible = true;
                  vm.templateIsLoading = false;
                })
            }
          }, 2000, {'leading': true}),
        getTemplates: _.throttle(
          async function(){
            if(this.ses){
              var params = { MaxItems: 10 };
              if(this.templates && this.templates.NextToken){
                params.NextToken = this.templates.NextToken;
              }
              let vm = this;
              vm.templatesAreLoading = true;
              await this.ses.listTemplates(params).promise()
                .then(templates => {
                  if(!vm.templates.TemplatesMetadata) vm.setTemplateMetadataReactive([]);
                  vm.setTemplateMetadataReactive(_.union(vm.templates.TemplatesMetadata, templates.TemplatesMetadata));
                  Vue.set(vm.templates, 'NextToken', templates.NextToken ? templates.NextToken : undefined);
                  this.nextToken = templates.NextToken ? templates.NextToken : undefined;
                  vm.templatesAreLoading = false;
                })
            }
          }, 2000, {'leading': true})
      }
    })
  </script>
</html>
